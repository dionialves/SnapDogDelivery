<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/fragments/layout :: layout(
          pageTitle=${pageTitle}, 
          activeMenu=${activeMenu}, 
          pageSubtitle=${pageSubtitle},
          headerActions=~{::headerActions},
          content=~{::content}
      )}">

<head>
    <title>Formulário de Cliente</title>
</head>

<body>

    <!-- Ações do Header - Botão Voltar -->
    <th:block th:fragment="headerActions">
        <a th:href="@{/admin/clients}"
            class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-800 px-4 py-2 rounded-lg font-medium transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            Voltar
        </a>
    </th:block>

    <!-- Conteúdo Principal -->
    <th:block th:fragment="content">

        <!-- Mensagem de Erro Geral -->
        <div th:if="${erro}" class="mb-6 p-4 rounded-lg bg-red-100 text-red-800 flex items-center gap-3">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span th:text="${erro}"></span>
        </div>

        <!-- Formulário -->
        <form th:action="${client.id != null} ? @{/admin/clients/{id}(id=${client.id})} : @{/admin/clients/new}"
            th:object="${client}" method="post" class="space-y-6">

            <!-- Card: Dados Pessoais -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-snapdog-600"></i>
                        Dados Pessoais
                    </h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- Nome -->
                    <div class="md:col-span-2">
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            Nome Completo <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="name" th:field="*{name}"
                            th:classappend="${#fields.hasErrors('name')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="Digite o nome completo">
                        <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="mt-1 text-sm text-red-500">
                        </p>
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            E-mail <span class="text-red-500">*</span>
                        </label>
                        <input type="email" id="email" th:field="*{email}"
                            th:classappend="${#fields.hasErrors('email')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="email@exemplo.com">
                        <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="mt-1 text-sm text-red-500">
                        </p>
                    </div>

                    <!-- Telefone -->
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                            Telefone <span class="text-red-500">*</span>
                        </label>
                        <input type="tel" id="phone" th:field="*{phone}"
                            th:classappend="${#fields.hasErrors('phone')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="(00) 00000-0000">
                        <p th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}" class="mt-1 text-sm text-red-500">
                        </p>
                    </div>

                </div>
            </div>

            <!-- Card: Endereço -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-5 h-5 text-snapdog-600"></i>
                        Endereço
                    </h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-6 gap-6">

                    <!-- CEP -->
                    <div class="md:col-span-2">
                        <label for="zipCode" class="block text-sm font-medium text-gray-700 mb-2">
                            CEP <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input type="text" id="zipCode" th:field="*{zipCode}"
                                th:classappend="${#fields.hasErrors('zipCode')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                                placeholder="00000-000" maxlength="9" onblur="searchZipCode(this.value)">
                            <div id="zipCodeLoading" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
                                <i data-lucide="loader-2" class="w-5 h-5 text-gray-400 animate-spin"></i>
                            </div>
                        </div>
                        <p th:if="${#fields.hasErrors('zipCode')}" th:errors="*{zipCode}"
                            class="mt-1 text-sm text-red-500"></p>
                    </div>

                    <!-- Rua -->
                    <div class="md:col-span-4">
                        <label for="street" class="block text-sm font-medium text-gray-700 mb-2">
                            Rua <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="street" th:field="*{street}"
                            th:classappend="${#fields.hasErrors('street')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="Nome da rua">
                        <p th:if="${#fields.hasErrors('street')}" th:errors="*{street}"
                            class="mt-1 text-sm text-red-500"></p>
                    </div>

                    <!-- Número -->
                    <div class="md:col-span-1">
                        <label for="number" class="block text-sm font-medium text-gray-700 mb-2">
                            Número <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="number" th:field="*{number}"
                            th:classappend="${#fields.hasErrors('number')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="Nº">
                        <p th:if="${#fields.hasErrors('number')}" th:errors="*{number}"
                            class="mt-1 text-sm text-red-500"></p>
                    </div>

                    <!-- Complemento -->
                    <div class="md:col-span-2">
                        <label for="complement" class="block text-sm font-medium text-gray-700 mb-2">
                            Complemento
                        </label>
                        <input type="text" id="complement" th:field="*{complement}"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="Apto, Bloco, etc.">
                    </div>

                    <!-- Bairro -->
                    <div class="md:col-span-3">
                        <label for="neighborhood" class="block text-sm font-medium text-gray-700 mb-2">
                            Bairro <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="neighborhood" th:field="*{neighborhood}"
                            th:classappend="${#fields.hasErrors('neighborhood')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="Nome do bairro">
                        <p th:if="${#fields.hasErrors('neighborhood')}" th:errors="*{neighborhood}"
                            class="mt-1 text-sm text-red-500"></p>
                    </div>

                    <!-- Cidade -->
                    <div class="md:col-span-4">
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                            Cidade <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="city" th:field="*{city}"
                            th:classappend="${#fields.hasErrors('city')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500"
                            placeholder="Nome da cidade">
                        <p th:if="${#fields.hasErrors('city')}" th:errors="*{city}" class="mt-1 text-sm text-red-500">
                        </p>
                    </div>

                    <!-- Estado -->
                    <div class="md:col-span-2">
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-2">
                            Estado
                        </label>
                        <select id="state" th:field="*{state}"
                            th:classappend="${#fields.hasErrors('state')} ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : ''"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-snapdog-500 focus:border-snapdog-500">
                            <option value="">Selecione</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                        <p th:if="${#fields.hasErrors('state')}" th:errors="*{state}" class="mt-1 text-sm text-red-500">
                        </p>
                    </div>

                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="flex items-center justify-end gap-4">
                <a th:href="@{/admin/clients}"
                    class="px-6 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition-colors">
                    Cancelar
                </a>
                <button type="submit"
                    class="px-6 py-2 bg-snapdog-600 hover:bg-snapdog-700 text-white rounded-lg font-medium transition-colors inline-flex items-center gap-2">
                    <i data-lucide="check" class="w-5 h-5"></i>
                    <span th:text="${client.id != null} ? 'Salvar Alterações' : 'Cadastrar Cliente'">Cadastrar
                        Cliente</span>
                </button>
            </div>

        </form>

        <!-- Script para busca de CEP -->
        <script>
            async function searchZipCode(zipCode) {
                zipCode = zipCode.replace(/\D/g, '');

                if (zipCode.length !== 8) return;

                const loading = document.getElementById('zipCodeLoading');
                loading.classList.remove('hidden');

                try {
                    const response = await fetch(`https://viacep.com.br/ws/${zipCode}/json/`);
                    const data = await response.json();

                    if (!data.erro) {
                        document.getElementById('street').value = data.logradouro || '';
                        document.getElementById('neighborhood').value = data.bairro || '';
                        document.getElementById('city').value = data.localidade || '';
                        document.getElementById('state').value = data.uf || '';

                        // Foca no campo número
                        document.getElementById('number').focus();
                    }
                } catch (error) {
                    console.error('Erro ao buscar CEP:', error);
                } finally {
                    loading.classList.add('hidden');
                    lucide.createIcons();
                }
            }

            // Máscara para CEP
            document.getElementById('zipCode').addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.slice(0, 5) + '-' + value.slice(5, 8);
                }
                e.target.value = value;
            });

            // Máscara para telefone
            document.getElementById('phone').addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);

                if (value.length > 6) {
                    value = '(' + value.slice(0, 2) + ') ' + value.slice(2, 7) + '-' + value.slice(7);
                } else if (value.length > 2) {
                    value = '(' + value.slice(0, 2) + ') ' + value.slice(2);
                } else if (value.length > 0) {
                    value = '(' + value;
                }
                e.target.value = value;
            });
        </script>

    </th:block>

</body>

</html>
